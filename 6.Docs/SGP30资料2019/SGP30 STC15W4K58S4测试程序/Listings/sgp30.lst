C51 COMPILER V9.00   SGP30                                                                 05/08/2019 15:27:55 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SGP30
OBJECT MODULE PLACED IN .\Objects\sgp30.obj
COMPILER INVOKED BY: d:\Keil_v5\C51\BIN\C51.EXE sgp30.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\sgp
                    -30.lst) TABS(2) OBJECT(.\Objects\sgp30.obj)

line level    source

   1          /***************************************************************
   2          *   File name    :  sgp30.c  
   3          *****************************************************************/
   4          #include "STC15W4K32S4.h"
   5          #include "sgp30.H" //SHTC3 head file 
   6          #include "delay.h"
   7          void delay_ms(uint);
   8          /*================================================================
   9          ¡¾  Name  ¡¿Pin Description
  10          ¡¾Function¡¿Ä£ÄâIICÊ¹ÓÃµÄÒý½Å¶¨Òå
  11          ¡¾  Notes ¡¿
  12          ================================================================*/
  13          /*************Pin Description*************
  14             SCL -P1.0     
  15             SDA -P1.1
  16          *****************************************/
  17          sbit SCL = P1^0;
  18          sbit SDA = P1^1;
  19          
  20          /*================================================================
  21          ¡¾  Name  ¡¿
  22          ¡¾Function¡¿Ó¦´ðÎ»µçÆ½¶¨Òå
  23          ¡¾  Notes ¡¿
  24          ================================================================*/
  25          #define ACK         0             //Ó¦´ðÐÅºÅ
  26          #define NACK        1             //·ÇÓ¦´ðÐÅºÅ
  27          /*------------------------------------------------------------*/
  28          /*================================================================
  29          ¡¾  Name  ¡¿void I2CDelay (uchar t)
  30          ¡¾Function¡¿Ä£ÄâIICÓÃµÄ¶ÌÑÓÊ± us
  31          ¡¾  Notes ¡¿
  32          ================================================================*/
  33          void I2CDelay (uchar t)          
  34          {
  35   1              while(t--);
  36   1      }
  37          
  38          /*================================================================
  39          ¡¾  Name  ¡¿void I2CStart(void)
  40          ¡¾Function¡¿I2CÆðÊ¼ÐÅºÅ
  41          ¡¾  Notes ¡¿SCL¡¢SDAÍ¬Îª¸ß£¬SDAÌø±ä³ÉµÍÖ®ºó£¬SCLÌø±ä³ÉµÍ          
  42          ================================================================*/
  43          void I2CStart(void)
  44          {        
  45   1                SDA = 1;                            //·¢ËÍÆðÊ¼Ìõ¼þµÄÊý¾ÝÐÅºÅ--ZLG
  46   1                SCL = 1;
  47   1                I2CDelay(50);                    //ÆðÊ¼Ìõ¼þ½¨Á¢Ê±¼ä´óÓÚ4.7us,ÑÓÊ±--ZLG
  48   1                SDA = 0;                            //·¢ËÍÆðÊ¼ÐÅºÅ-ZLG
  49   1                I2CDelay(50);                    //ÆðÊ¼Ìõ¼þËø¶¨Ê±¼ä´óÓÚ4¦Ìs--ZLG
  50   1                SCL = 0;                            //Ç¯×¡I2C×ÜÏß£¬×¼±¸·¢ËÍ»ò½ÓÊÕÊý¾Ý--ZLG
  51   1                I2CDelay(50);         
  52   1      }
  53          
  54          /*================================================================
C51 COMPILER V9.00   SGP30                                                                 05/08/2019 15:27:55 PAGE 2   

  55          ¡¾  Name  ¡¿void I2CStop(void)
  56          ¡¾Function¡¿I2CÍ£Ö¹ÐÅºÅ
  57          ¡¾  Notes ¡¿SCL¡¢SDAÍ¬ÎªµÍ£¬SCLÌø±ä³É¸ßÖ®ºó£¬SDAÌø±ä³É¸ß           
  58          ================================================================*/
  59          void I2CStop(void)
  60          {        
  61   1                SDA = 0;                        //·¢ËÍ½áÊøÌõ¼þµÄÊý¾ÝÐÅºÅ--ZLG
  62   1                SCL = 0;
  63   1                I2CDelay(50);
  64   1                SCL = 1;                        //·¢ËÍ½áÊøÌõ¼þµÄÊ±ÖÓÐÅºÅ--ZLG
  65   1                I2CDelay(50);                //½áÊøÌõ¼þ½¨Á¢Ê±¼ä´óÓÚ4¦Ìs--ZLG
  66   1                SDA = 1;                        //·¢ËÍI2C×ÜÏß½áÊøÐÅºÅ--ZLG
  67   1                I2CDelay(50); 
  68   1      }
  69          
  70          /*================================================================
  71          ¡¾  Name  ¡¿uchar I2C_Write_Byte(uchar WRByte)
  72          ¡¾Function¡¿I2CÐ´Ò»¸ö×Ö½ÚÊý¾Ý£¬·µ»ØACK»òÕßNACK
  73          ¡¾  Notes ¡¿´Ó¸ßµ½µÍ£¬ÒÀ´Î·¢ËÍ
  74          ================================================================*/
  75          uchar I2C_Write_Byte(uchar Write_Byte)  //Sendbyte
  76          {
  77   1              uchar i;   
  78   1              SCL=0;  
  79   1              I2CDelay(10); 
  80   1              for(i=0;i<8;i++)              //Òª´«ËÍµÄÊý¾Ý³¤¶ÈÎª8Î»--ZLG
  81   1              {         
  82   2                    if(Write_Byte&0x80)   //ÅÐ¶Ï·¢ËÍÎ»--ZLG
  83   2                    {
  84   3                            SDA = 1;        
  85   3                    }
  86   2                    else
  87   2                    {
  88   3                            SDA = 0;
  89   3                    }
  90   2                    I2CDelay(5);                
  91   2                    SCL=1;                //Êä³öSDAÎÈ¶¨ºó£¬À­¸ßSCL¸ø³öÉÏÉýÑØ£¬´Ó»ú¼ì²âµ½ºó½øÐÐÊý¾Ý²ÉÑù      
  92   2                    I2CDelay(5);         //±£Ö¤Ê±ÖÓ¸ßµçÆ½ÖÜÆÚ´óÓÚ4¦Ìs--ZLG
  93   2                    SCL=0;
  94   2                    I2CDelay(5);
  95   2                    Write_Byte <<= 1;
  96   2              } 
  97   1              I2CDelay(1);
  98   1              SDA = 1;                      //8Î»·¢ËÍÍêºóÊÍ·ÅÊý¾ÝÏß£¬×¼±¸½ÓÊÕÓ¦´ðÎ»-ZLG
  99   1              I2CDelay(40);
 100   1              SCL = 1;                      //MCU¸æÖªSHT2XÊý¾Ý·¢ËÍÍê±Ï£¬µÈ´ý´Ó»úµÄÓ¦´ðÐÅºÅ        
 101   1              I2CDelay(40);                   
 102   1              /*ÒÔÏÂÊÇÅÐ¶ÏI2C×ÜÏß½ÓÊÕÓ¦µ½Ó¦´ðÐÅºÅÊÇACK»¹ÊÇNACK*/
 103   1              if(SDA==1)                                   //SDAÎª¸ß£¬ÊÕµ½NACK
 104   1              {
 105   2                  SCL=0;
 106   2                  return NACK;   
 107   2                  I2CDelay(40); 
 108   2              }        
 109   1              else                                         //SDAÎªµÍ£¬ÊÕµ½ACK 
 110   1              {
 111   2                  SCL=0;
 112   2                  return ACK;  
 113   2                  I2CDelay(40); 
 114   2              }  
 115   1      }
 116          
C51 COMPILER V9.00   SGP30                                                                 05/08/2019 15:27:55 PAGE 3   

 117          /*================================================================
 118          ¡¾  Name  ¡¿uchar I2C_Read_Byte(uchar AckValue)
 119          ¡¾Function¡¿I2C¶ÁÒ»¸ö×Ö½ÚÊý¾Ý£¬Èë¿Ú²ÎÊýÓÃÓÚ¿ØÖÆÓ¦´ð×´Ì¬£¬ACK»òÕßNACK
 120          ¡¾  Notes ¡¿´Ó¸ßµ½µÍ£¬ÒÀ´Î½ÓÊÕ
 121          ================================================================*/
 122          uchar I2C_Read_Byte(uchar AckValue)//receivebyte
 123          {
 124   1              uchar i,RDByte=0;
 125   1              SCL=0;                                   //ÖÃÊ±ÖÓÏßÎªµÍ£¬×¼±¸½ÓÊÕÊý¾ÝÎ»--ZLG
 126   1              I2CDelay(40);  
 127   1              SDA = 1;                                 //ÊÍ·Å×ÜÏß,ÖÃÊý¾ÝÏßÎªÊäÈë·½Ê½--ZLG        
 128   1              for (i=0;i<8;i++) 
 129   1              {        
 130   2                      SCL = 1;                          //SCL¸ßµçÆ½ÆÚ¼ä£¬²É¼¯SDAÐÅºÅ£¬²¢×÷ÎªÓÐÐ§Êý¾Ý //ÖÃÊ±ÖÓÏßÎ
             -ª¸ßÊ¹Êý¾ÝÏßÉÏÊý¾ÝÓÐÐ§--ZLG 
 131   2                      I2CDelay(20);
 132   2                      RDByte <<= 1;                  //ÒÆÎ»
 133   2                      if(SDA==1)                           //²ÉÑù»ñÈ¡Êý¾Ý
 134   2                      {
 135   3                              RDByte |= 0x01;
 136   3                      }
 137   2                      else
 138   2                      {
 139   3                              RDByte &= 0xfe;
 140   3                      }
 141   2                      I2CDelay(10);
 142   2                      SCL = 0;                             //ÏÂ½µÑØ£¬´Ó»ú¸ø³öÏÂÒ»Î»Öµ
 143   2                      I2CDelay(60);
 144   2              }   
 145   1              /*ÒÔÏÂÊÇI2C×ÜÏß·¢ËÍÓ¦´ðÐÅºÅACK»òÕßNACK*/
 146   1              SDA = AckValue;                      //Ó¦´ð×´Ì¬        
 147   1              I2CDelay(30);
 148   1              SCL = 1;                         
 149   1              I2CDelay(50);                  //Ê±ÖÓµÍµçÆ½ÖÜÆÚ´óÓÚ4¦Ìs--ZLG
 150   1              SCL = 0;                                  //ÇåÊ±ÖÓÏß£¬Ç¯×¡I2C×ÜÏßÒÔ±ã¼ÌÐø½ÓÊÕ--ZLG               
 151   1              I2CDelay(150);       
 152   1              return RDByte;
 153   1      }
 154          
 155          
 156          //³õÊ¼»¯IIC½Ó¿Ú
 157          void SGP30_Init(void)
 158          {
 159   1        SGP30_ad_write(0x20,0x03);
 160   1      //  SGP30_ad_write(0x20,0x61);
 161   1      //  SGP30_ad_write(0x01,0x00);
 162   1      }
 163          
 164          void SGP30_ad_write(uchar a, uchar b)
 165          {
 166   1          I2CStart();
 167   1          I2C_Write_Byte(SGP30_write); //·¢ËÍÆ÷¼þµØÖ·+Ð´Ö¸Áî
 168   1          I2C_Write_Byte(a);    //·¢ËÍ¿ØÖÆ×Ö½Ú
 169   1          I2C_Write_Byte(b);
 170   1          I2CStop();
 171   1          delay_ms(100);
 172   1      }
 173          
 174          unsigned long SGP30_ad_read(void)
 175          {
 176   1          unsigned long dat;
 177   1          int crc;
C51 COMPILER V9.00   SGP30                                                                 05/08/2019 15:27:55 PAGE 4   

 178   1          I2CStart();
 179   1          I2C_Write_Byte(SGP30_read); //·¢ËÍÆ÷¼þµØÖ·+¶ÁÖ¸Áî
 180   1          dat = I2C_Read_Byte(ACK);
 181   1          dat <<= 8;
 182   1          dat += I2C_Read_Byte(ACK);
 183   1          crc = I2C_Read_Byte(ACK); //checkÊý¾Ý£¬ÉáÈ¥
 184   1          crc = crc;             //±ÜÃâ±àÒë²úÉú¾¯¸æ£¬Õâ¾ä¿ÉÓÐ¿ÉÎÞ
 185   1          dat <<= 8;
 186   1          dat += I2C_Read_Byte(ACK);
 187   1          dat <<= 8;
 188   1          dat += I2C_Read_Byte(NACK);
 189   1          I2CStop();
 190   1          return(dat);
 191   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    406    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
